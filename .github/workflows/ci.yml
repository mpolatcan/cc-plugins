name: cc-plugins CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          # Validate all JSON files
          invalid=0
          while IFS= read -r -d '' file; do
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "ERROR: Invalid JSON in $file"
              invalid=1
            fi
          done < <(find . -name "*.json" -not -path "./.git/*" -print0)
          if [ $invalid -eq 1 ]; then
            exit 1
          fi

      - name: Validate plugin structure
        run: |
          # Check required files for each plugin
          for plugin in plugins/*/; do
            if [ -d "$plugin" ]; then
              plugin_name=$(basename "$plugin")
              echo "Validating $plugin_name..."

              # Check for hooks (either in hooks/ dir or inline in plugin.json)
              has_hooks_dir=false
              has_hooks_in_manifest=false
              [[ -d "$plugin/hooks" ]] && has_hooks_dir=true
              [[ -f "$plugin/.claude-plugin/plugin.json" ]] && grep -q '"hooks"' "$plugin/.claude-plugin/plugin.json" && has_hooks_in_manifest=true
              if ! $has_hooks_dir && ! $has_hooks_in_manifest; then
                echo "WARNING: Missing hooks in $plugin_name (neither hooks/ nor hooks in plugin.json)"
              fi

              # Check for required files
              [ -f "$plugin/.claude-plugin/plugin.json" ] || echo "ERROR: Missing plugin.json in $plugin_name"
            fi
          done

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          check_todos: false
          severity: error

  install-script-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test install script syntax
        run: |
          # Check bash syntax for all shell scripts
          for script in $(find . -name "*.sh"); do
            echo "Checking syntax of $script"
            if ! bash -n "$script"; then
              echo "ERROR: Syntax error in $script"
              exit 1
            fi
          done
